#!/usr/bin/env ruby

require "yaml"
require "fileutils"
require "net/sftp"

config = YAML.load_file(File.expand_path("~/.seedsync"))

host = config["host"]
username = config["username"]
password = config["password"]
remote_path = config["remote_path"]
local_path = File.expand_path(config["local_path"])

FileUtils.mkdir_p(local_path)

Net::SFTP.start(host, username, :password => password) do |sftp|
  sftp.dir.foreach(remote_path) do |entry|
    next if [".", ".."].include?(entry.name)

    remote_link = File.join(remote_path, entry.name)
    remote = sftp.readlink!(remote_link).name
    local = File.join(local_path, entry.name)
    options = (sftp.file.directory?(remote) ? { :recursive => true } : {})
    sftp.download!(remote, local, options)
    sftp.remove!(remote_link)
  end
end
